var l=class{_events={};on(s,t){let e=s;this._events[e]||(this._events[e]=[]),this._events[e].push(t)}once(s,t){let e=(...n)=>{this.off(s,e),t(...n)};this.on(s,e)}off(s,t){let e=s;this._events[e]&&(this._events[e]=this._events[e].filter(n=>n!==t))}emit(s,...t){let e=this._events[s];e&&e.length>0&&e.forEach(n=>{n(...t)})}listenerCount(s){return this._events[s]?.length||0}},h=l;var u=class{ws;ackIdCounter;ackCallbacks;handlers=new h;opts;url;connected=!1;_manuallyDisconnected=!1;constructor(s,t={}){this.ackIdCounter=1,this.ackCallbacks=new Map,this.opts={logs:!1,reConnect:!0,reConnectInterval:1e3,token:null,autoConnect:!0,...t},this.url=new URL(s,window?window.location.href.replace("http","ws"):"ws://localhost"),this.opts.token&&this.url.searchParams.set("token",this.opts.token),this.opts.autoConnect&&this.connect()}connect(){this._manuallyDisconnected=!1;let s=Date.now().toString(36)+Math.random().toString(36).substring(2,10);this.url.searchParams.set("id",s),this.ws=new WebSocket(this.url.href),this.ws.onopen=()=>{this.connected=!0,this.opts.logs&&console.log("[ws] Connected"),this.handlers.emit("connect",this.ws)},this.ws.onerror=(...t)=>{this.opts.logs&&console.warn("[ws] Error:",t),this.handlers.emit("error",...t)},this.ws.onmessage=t=>{let e=t?.data?.toString()||t?.toString()||"",n;try{n=JSON.parse(e)}catch{this.opts.logs&&console.warn("[ws] Invalid JSON:",e);return}if("ack"in n){let i=n.ack,r=this.ackCallbacks.get(i);r&&(this.ackCallbacks.delete(i),r(...n.data));return}let{evt:o,data:a,ackI:c}=n;if(!(!o||a&&!Array.isArray(a))){if(Array.isArray(c))for(let i=0;i<c.length;i++){let r=c[i];if(!a[r])break;let p=a[r];a[r]=(...v)=>{this.ws.send(JSON.stringify({ack:p,data:v}))}}this.handlers.emit(o,...a)}},this.ws.onclose=async t=>{if(this.connected=!1,this.opts.logs&&console.log("[ws] Disconnected",t),this.handlers.emit("disconnect",this.ws,t),this._manuallyDisconnected){this._manuallyDisconnected=!1;return}if(t.code===1006){this.opts.logs&&console.log("[ws] Connection closed by server");let e=new URLSearchParams;e.set("id",s),e.set("path",this.url.pathname);let n=await fetch("/gloves-link/status?"+e.toString()).then(a=>a.json());if(n.err){this.opts.logs&&console.log("[ws] Status error",n.msg);return}let o=n.status;this.opts.logs&&console.log("[ws] Status",o),o.status===401?this.handlers.emit("unauthorized",this.ws):o.status===403?this.handlers.emit("forbidden",this.ws):o.status===500&&this.handlers.emit("serverError",this.ws);return}this.opts.reConnect&&setTimeout(()=>{this.connect()},this.opts.reConnectInterval)}}on(s,t){this.handlers.on(s,t)}once(s,t){this.handlers.once(s,t)}emit(s,...t){let e=t.map((n,o)=>{if(typeof n=="function")return o}).filter(n=>n!==void 0);for(let n=0;n<e.length;n++){let o=e[n],a=this.ackIdCounter++;this.ackCallbacks.set(a,t[o]),t[o]=a}this.ws.send(JSON.stringify({evt:s,data:t||void 0,ackI:e.length?e:void 0}))}send(s,...t){return this.emit(s,...t)}disconnect(){this._manuallyDisconnected=!0,this.ws.close()}close(){this.ws.close()}};export{u as GLC,u as GlovesLinkClient,u as client,u as default};
//# sourceMappingURL=GlovesLinkClient.js.map
